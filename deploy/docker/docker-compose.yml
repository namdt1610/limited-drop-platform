version: "3.8"

services:
  # Nginx - Reverse proxy & SSL termination
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: donald-nginx
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - nocodb
      - backend
    networks:
      - donald-network
    restart: unless-stopped
    environment:
      - TZ=UTC

  # Backend - Go API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: donald-backend
    ports:
      - "3030:3030"
    environment:
      - DATABASE_URL=./database.db
      - PORT=3030
      - ENV=production
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT=http://localstack:4566
      - S3_BUCKET_NAME=donald-uploads
      - STORAGE_PROVIDER=s3 # s3 or cloudinary
      # Keep Cloudinary config as backup
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
    volumes:
      - ./backend/database.db:/app/database.db
    depends_on:
      - localstack
    networks:
      - donald-network
    restart: unless-stopped

  # LocalStack - S3 Emulation
  localstack:
    image: localstack/localstack:latest
    container_name: donald-localstack
    ports:
      - "4566:4566"            # Edge port
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
    volumes:
      - "./localstack_data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - donald-network

  # NocoDB - Content Management
  nocodb:
    image: nocodb/nocodb:latest
    container_name: donald-nocodb
    environment:
      NC_DB: sqlite3:///${DB_PATH:-./database.db}
      NC_PUBLIC_URL: ${NOCODB_PUBLIC_URL:-http://localhost:8080}
      NC_DISABLE_TELEMETRY: ${NOCODB_DISABLE_TELEMETRY:-true}
      NC_JWT_SECRET: ${NOCODB_JWT_SECRET}
      NC_ADMIN_EMAIL: ${NOCODB_ADMIN_EMAIL}
      NC_ADMIN_PASSWORD: ${NOCODB_ADMIN_PASSWORD}
    ports:
      - "${NOCODB_PORT:-8081}:8080"
    networks:
      - donald-network
    restart: unless-stopped
    volumes:
      - ./${DB_PATH:-./database.db}:/usr/app/database.db
      - nocodb_data:/usr/app/data

volumes:
  nocodb_data:
    driver: local

networks:
  donald-network:
    driver: bridge